<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Inbox</title>
    <link rel="stylesheet" th:href="@{/css/messages.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script src="/js/messages.js" defer></script>
</head>
<body>

<header>
    <h1>Inbox</h1>
    <a th:href="${session.role == 'STUDENT' ? '/student/dashboard' : '/faculty/dashboard'}" class="nav-btn">Back to Dashboard</a>
    <a href="/" class="nav-btn">Logout</a>
</header>

<div class="chat-container">
    <!-- Left Sidebar (User List) -->
    <div class="user-list">
        <h3>Your Conversations</h3>
        <ul id="chatUserList">
            <li th:each="user : ${chatUsers}" th:attr="data-email=${user}" onclick="loadChat(this)">
                <span th:text="${user}"></span>
            </li>
        </ul>
    </div>

    <!-- Right Side (Chat Box) -->
    <div class="chat-box" id="chatBox">
        <h3 id="chatTitle">Select a conversation</h3>
        <div id="messageContainer"></div>

        <div class="message-input">
            <input type="hidden" id="senderEmail" th:value="${session.loggedInUserEmail}">
            <input type="hidden" id="receiverEmail">
            <textarea id="messageInput" placeholder="Type a message..."></textarea>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    let receiverEmail = '';

    stompClient.connect({}, function () {
        console.log("Connected to WebSocket");

        // Subscribe to receive messages
        stompClient.subscribe("/topic/messages", function (message) {
            const receivedMessage = JSON.parse(message.body);
            updateChat(receivedMessage);
        });
    });

    function loadChat(element) {
        receiverEmail = element.getAttribute("data-email");
        document.getElementById("chatTitle").innerText = "Chat with " + receiverEmail;
        document.getElementById("receiverEmail").value = receiverEmail;

        // Fetch previous chat messages
        fetch(`/messages/chat/${receiverEmail}`)
            .then(response => response.json())
            .then(messages => {
                const messageContainer = document.getElementById("messageContainer");
                messageContainer.innerHTML = '';
                messages.forEach(msg => {
                    let messageDiv = document.createElement("div");
                    messageDiv.classList.add(msg.senderEmail === document.getElementById("senderEmail").value ? "sent" : "received");
                    messageDiv.innerHTML = `<strong>${msg.senderEmail}:</strong> ${msg.content}`;
                    messageContainer.appendChild(messageDiv);
                });
            });
    }

    function sendMessage() {
        const senderEmail = document.getElementById("senderEmail").value;
        const messageInput = document.getElementById("messageInput").value;

        if (!receiverEmail || !messageInput.trim()) return;

        const message = {
            senderEmail: senderEmail,
            receiverEmail: receiverEmail,
            content: messageInput
        };

        stompClient.send("/app/sendMessage", {}, JSON.stringify(message));
        document.getElementById("messageInput").value = ''; // Clear input
    }

    function updateChat(message) {
        if (message.receiverEmail === receiverEmail || message.senderEmail === receiverEmail) {
            let messageDiv = document.createElement("div");
            messageDiv.classList.add(message.senderEmail === document.getElementById("senderEmail").value ? "sent" : "received");
            messageDiv.innerHTML = `<strong>${message.senderEmail}:</strong> ${message.content}`;
            document.getElementById("messageContainer").appendChild(messageDiv);
        }
    }
</script>

</body>
</html>
